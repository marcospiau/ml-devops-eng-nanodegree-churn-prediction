# Predict Customer Churn

This repository contain my submission for the project **Predict Customer Churn**, project for lesson **2. Clean Code Principles**, included in [ML DevOps Engineer Nanodegree Udacity](https://www.udacity.com/course/machine-learning-dev-ops-engineer-nanodegree--nd0821).

This project uses machine learning models to predict which customers are more likely to cancel their account, with clean code principles.

# How this repo is organized
```bash
.
├── CHANGELOG.md # infos about versions
├── churn_library.py #  main code, can be executed from command line
├── churn_script_logging_and_tests.py #  tests for churn_library.py
├── config.yml: # configuration file used to run churn_library.py from command line
├── data # data files
├── environment.yml # Anaconda environment info
├── outputs # outputs generated by churn_library.py
├── README.md # this file
├── test_data # data used for tests
└── test_outputs #output genereated by tests
```



# How to setup the environment
We use miniconda to manage Python packages installation.

Install minconda (skip if Anaconda or Miniconda are installed):
```bash
curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash ./Miniconda3-latest-Linux-x86_64.sh
source ~/.bashrc
```

The following command creates a conda env named `uda_1`.
```bash
conda env create -f environment.yml python=3.8 --name uda_1
```

Activate the environement:
```bash
conda activate uda_1
```
# Running Files
How do you run your files? What should happen when you run your files?
## Main script
The main script (`churn_library.py`) performs the entire modeling pipeline:
 - load data
 - perform EDA and save plots
 - performe feature engineering, treating quantitative and categorical features accordingly
 - fits a logistic regression model and perform a grid search over a random forest model, and saves objects that can be used for making predictions on new data
 - saves results for each model

The script can be executed with:
```bash
python3 churn_library.py --config=config.yml
```

Everything necessary to run the process is configurable via the config file. Comments on `config.yml` shows how to configure each section of the config file.

Script help:
```bash
usage: churn_library.py [-h] --config CONFIG

Run modeling for chun analysis

optional arguments:
  -h, --help       show this help message and exit
  --config CONFIG  yaml configuration file (default: None)
```

Below is expected directory tree, with description of each file.
```bash
outputs/
├── images # image outputs
│   └── eda # eda images outputs
│       ├── categorical_features # plots for categorical features:
│       │   ├── mean_response_{feat_name}.png: mean response by category leval, one for each feature
│       │   ├── mean_response_{feat_name}.png: mean response by category leval, one for each feature
│       │   └── univariate_distribution_{feat_name}.png: example counts by category level, one for each feature
│       ├── quantitative_features # plots for quantitative features
│       │   ├── correlation_matrix_quant_columns.png: correlation matrix of all quantitative features (including target column)
│       │   ├── histogram_by_target_{feat_name}.png: histogram by target level
│       │   └── univariate_histogram_{feat_name}.png
│       └── target # plots for target column
│           └── target_distribution.png: target counts by level
├── logs # process logs
    └── results.log
├── models # serialized pickle models
│   ├── logistic_model.pkl # serialized logistic regression model
│   └── rfc_model.pkl # serialized random forest classifier
└── results # Results plots
    ├── auc_roc_curves.png # AUC plot, for each model and data partition (train, test)
    ├── classification_report_image.png # classification report, for each model and data partition (train, test)
    ├── logistic_model_coefs.png # coefficients for logistic regression model
    └── rfc_model_feature_importances.png # feature importances for random forest classifier model
```

## Tests
For tests, we use [`unittest`](https://docs.python.org/3/library/unittest.html) for writing tests and [`pytest`](https://docs.pytest.org/) for running them. Below are code to run tests from commmand line and expected results (passed all tests):
```bash
python3 -m pytest -vv churn_script_logging_and_tests.py

======================================================================================================================== test session starts ========================================================================================================================
platform linux -- Python 3.8.12, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 -- /home/marcospiau/miniconda3/envs/uda_1/bin/python3
cachedir: .pytest_cache
rootdir: /home/marcospiau/git_repos/ml-devops-eng-nanodegree/ml-devops-eng-nanodegree-churn-prediction
plugins: xdist-2.5.0, forked-1.4.0
collected 43 items                                                                                                                                                                                                                                                  

churn_script_logging_and_tests.py::TestImportData::test_empty_data_error PASSED                                                                                                                                                                               [  2%]
churn_script_logging_and_tests.py::TestImportData::test_inexistent_file_error PASSED                                                                                                                                                                          [  4%]
churn_script_logging_and_tests.py::TestImportData::test_ok_file PASSED                                                                                                                                                                                        [  6%]
churn_script_logging_and_tests.py::TestYamlLoading::test_load_fake_file PASSED                                                                                                                                                                                [  9%]
churn_script_logging_and_tests.py::TestCreateDirectoryTree::test_correct_creation PASSED                                                                                                                                                                      [ 11%]
churn_script_logging_and_tests.py::TestCreateDirectoryTree::test_error_if_exists PASSED                                                                                                                                                                       [ 13%]
churn_script_logging_and_tests.py::TestEda::test_eda_categorical_features_plots_created PASSED                                                                                                                                                                [ 16%]
churn_script_logging_and_tests.py::TestEda::test_eda_directory_tree_correct PASSED                                                                                                                                                                            [ 18%]
churn_script_logging_and_tests.py::TestEda::test_eda_quant_features_plots_created PASSED                                                                                                                                                                      [ 20%]
churn_script_logging_and_tests.py::TestEda::test_eda_target_plot_created PASSED                                                                                                                                                                               [ 23%]
churn_script_logging_and_tests.py::TestCategoricalEncoder::test_correct_dtype PASSED                                                                                                                                                                          [ 25%]
churn_script_logging_and_tests.py::TestCategoricalEncoder::test_correct_feature_names PASSED                                                                                                                                                                  [ 27%]
churn_script_logging_and_tests.py::TestCategoricalEncoder::test_correct_shape PASSED                                                                                                                                                                          [ 30%]
churn_script_logging_and_tests.py::TestCategoricalEncoder::test_index_not_modified PASSED                                                                                                                                                                     [ 32%]
churn_script_logging_and_tests.py::TestFeatureEngineering::test_consistent_length_x_y_test PASSED                                                                                                                                                             [ 34%]
churn_script_logging_and_tests.py::TestFeatureEngineering::test_consistent_length_x_y_train PASSED                                                                                                                                                            [ 37%]
churn_script_logging_and_tests.py::TestFeatureEngineering::test_correct_feature_names PASSED                                                                                                                                                                  [ 39%]
churn_script_logging_and_tests.py::TestFeatureEngineering::test_x_dtype PASSED                                                                                                                                                                                [ 41%]
churn_script_logging_and_tests.py::TestFeatureEngineering::test_y_dtype PASSED                                                                                                                                                                                [ 44%]
churn_script_logging_and_tests.py::TestClassificationReportPlots::test_kwargs_plot PASSED                                                                                                                                                                     [ 46%]
churn_script_logging_and_tests.py::TestClassificationReportPlots::test_simple_plot PASSED                                                                                                                                                                     [ 48%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_coef_and_feature_names_in PASSED                                                                                                                                               [ 51%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_coef_and_intercept PASSED                                                                                                                                                      [ 53%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_coef_and_no_intercept PASSED                                                                                                                                                   [ 55%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_coef_and_wrong_intercept PASSED                                                                                                                                                [ 58%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_coef_intercept_and_feature_names_in PASSED                                                                                                                                     [ 60%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_feature_importances PASSED                                                                                                                                                     [ 62%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_model_with_feature_importances_and_feature_names_in_ PASSED                                                                                                                               [ 65%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_no_feature_importances_provided PASSED                                                                                                                                                    [ 67%]
churn_script_logging_and_tests.py::TestFeatureImportancePlots::test_no_feature_names_provided PASSED                                                                                                                                                          [ 69%]
churn_script_logging_and_tests.py::TestAUCPlots::test_plot_multiple_curves PASSED                                                                                                                                                                             [ 72%]
churn_script_logging_and_tests.py::TestAUCPlots::test_plot_single_curve PASSED                                                                                                                                                                                [ 74%]
churn_script_logging_and_tests.py::TestLoadModelCls::test_decision_tree_classifier PASSED                                                                                                                                                                     [ 76%]
churn_script_logging_and_tests.py::TestLoadModelCls::test_logistic_regression PASSED                                                                                                                                                                          [ 79%]
churn_script_logging_and_tests.py::TestLoadModelCls::test_random_forest_classifier PASSED                                                                                                                                                                     [ 81%]
churn_script_logging_and_tests.py::TestRunGrid::test_can_run_dummy_grid PASSED                                                                                                                                                                                [ 83%]
churn_script_logging_and_tests.py::TestRunGrid::test_can_run_logistic_regression PASSED                                                                                                                                                                       [ 86%]
churn_script_logging_and_tests.py::TestRunGrid::test_can_run_random_forest PASSED                                                                                                                                                                             [ 88%]
churn_script_logging_and_tests.py::TestTrainModels::test_auc_plot_is_saved PASSED                                                                                                                                                                             [ 90%]
churn_script_logging_and_tests.py::TestTrainModels::test_classification_report_image_is_saved PASSED                                                                                                                                                          [ 93%]
churn_script_logging_and_tests.py::TestTrainModels::test_feature_importance_plots_are_saved PASSED                                                                                                                                                            [ 95%]
churn_script_logging_and_tests.py::TestTrainModels::test_load_and_make_predictions_serialized_models PASSED                                                                                                                                                   [ 97%]
churn_script_logging_and_tests.py::TestTrainModels::test_serialized_models_are_saved PASSED                                                                                                                                                                   [100%]

======================================================================================================================== 43 passed in 7.50s =========================================================================================================================

```

## Linting
[`pylint`](https://pylint.org/) is used for code linting. Pylint configuration file `.pylintrc` is modified to supress warning about variables commonly used in data science (ie: df, X_train, etc). Below is the command and expected output using `pylint`:
```bash
python3 -m pylint *.py

************* Module churn_library
churn_library.py:484:5: W0511: TODO: make this configurable (fixme)

------------------------------------------------------------------
Your code has been rated at 9.98/10 (previous run: 9.98/10, +0.00)
```
## Code formatting
For code formatting, a mix of [`yapf`](https://github.com/google/yapf), [`autopep8`](https://github.com/hhatto/autopep8)] and manual adjustments is used.
For code formatting, a mix of [`yapf`](https://github.com/google/yapf), [`autopep8`](https://github.com/hhatto/autopep8)], both using default settings. [`isort`](https://github.com/PyCQA/isort) is used to sort imports. How to use:
```bash
# Using yapf
yapf -i *.py
# Using autopep8
autopep8 -iaa *.py
# Using isort
isort *.py
```